<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Hobby Hubby{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Hobby Hubby</a>
            
            <!-- Mobile toggle button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent" aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarContent">
                <!-- Search Form -->
                <div class="navbar-nav flex-grow-1 justify-content-center mx-3 d-none d-lg-flex">
                    <form class="d-flex w-100" role="search" style="max-width: 500px;" action="{% url 'forums:search' %}" method="get">
                        <div class="position-relative w-100">
                            <input class="form-control" 
                                   type="search" 
                                   name="query"
                                   placeholder="Search discussions, users, topics..." 
                                   aria-label="Search forum content"
                                   id="navbar-search"
                                   autocomplete="off"
                                   {% if request.GET.query %}value="{{ request.GET.query }}"{% endif %}>
                            <div class="search-suggestions position-absolute w-100 bg-white border rounded-bottom shadow-sm" 
                                 style="z-index: 1050; display: none; top: 100%; left: 0;"
                                 id="search-suggestions"
                                 role="listbox"
                                 aria-label="Search suggestions">
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- Navigation Links -->
                <div class="navbar-nav ms-auto">
                    <a class="nav-link" href="{% url 'forums:category_list' %}">
                        <i class="fas fa-home me-1"></i>Forums
                    </a>
                    {% if user.is_authenticated %}
                        <a class="nav-link" href="{% url 'accounts:inbox' %}">
                            <i class="fas fa-envelope me-1"></i>Messages
                        </a>
                        <a class="nav-link" href="{% url 'accounts:friend_requests' %}">
                            <i class="fas fa-user-friends me-1"></i>Friends
                        </a>
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user me-1"></i>{{ user.display_name }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                                <li><a class="dropdown-item" href="{% url 'accounts:user_profile' user_id=user.id %}">
                                    <i class="fas fa-user me-2"></i>My Profile
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'accounts:profile_edit' %}">
                                    <i class="fas fa-edit me-2"></i>Edit Profile
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'accounts:bookmarks' %}">
                                    <i class="fas fa-bookmark me-2"></i>Bookmarks
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'accounts:photo_gallery' user_id=user.id %}">
                                    <i class="fas fa-images me-2"></i>My Photos
                                </a></li>
                                {% if user.is_staff %}
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="{% url 'forums:analytics_dashboard' %}">
                                    <i class="fas fa-chart-line me-2"></i>Analytics Dashboard
                                </a></li>
                                <li><a class="dropdown-item" href="{% url 'admin:index' %}" target="_blank">
                                    <i class="fas fa-cogs me-2"></i>Admin Panel
                                </a></li>
                                {% endif %}
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <form method="post" action="{% url 'accounts:logout' %}" class="d-inline w-100">
                                        {% csrf_token %}
                                        <button type="submit" class="dropdown-item">
                                            <i class="fas fa-sign-out-alt me-2"></i>Logout
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                    {% else %}
                        <a class="nav-link" href="{% url 'accounts:login' %}">
                            <i class="fas fa-sign-in-alt me-1"></i>Login
                        </a>
                        <a class="nav-link" href="{% url 'accounts:register' %}">
                            <i class="fas fa-user-plus me-1"></i>Register
                        </a>
                    {% endif %}
                    {% if user.is_staff %}
                        <a class="nav-link" href="/admin/">
                            <i class="fas fa-cog me-1"></i>Admin
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <main class="container mt-4">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% block content %}
        {% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Search Autocomplete JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('navbar-search');
        const suggestionsContainer = document.getElementById('search-suggestions');
        let searchTimeout;
        let currentSuggestionIndex = -1;
        let suggestions = [];
        
        if (!searchInput || !suggestionsContainer) return;
        
        // Debounced search function
        function performSearch(query) {
            if (query.length < 2) {
                hideSuggestions();
                return;
            }
            
            // Make AJAX request to search suggestions endpoint
            fetch(`{% url 'forums:search_suggestions' %}?q=${encodeURIComponent(query)}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                }
            })
            .then(response => response.json())
            .then(data => {
                suggestions = data.suggestions || [];
                displaySuggestions(suggestions);
            })
            .catch(error => {
                console.error('Search suggestions error:', error);
                hideSuggestions();
            });
        }
        
        // Display search suggestions
        function displaySuggestions(suggestions) {
            if (suggestions.length === 0) {
                hideSuggestions();
                return;
            }
            
            let html = '';
            suggestions.forEach((suggestion, index) => {
                const iconClass = getIconClass(suggestion.type);
                html += `
                    <div class="search-suggestion-item p-2 border-bottom cursor-pointer" 
                         data-index="${index}"
                         data-url="${suggestion.url}"
                         style="cursor: pointer;">
                        <div class="d-flex align-items-center">
                            <i class="${iconClass} me-2 text-muted"></i>
                            <div class="flex-grow-1">
                                <div class="fw-bold text-dark">${escapeHtml(suggestion.title)}</div>
                                <small class="text-muted">${escapeHtml(suggestion.description)}</small>
                            </div>
                            <small class="badge bg-secondary">${suggestion.type}</small>
                        </div>
                    </div>
                `;
            });
            
            suggestionsContainer.innerHTML = html;
            suggestionsContainer.style.display = 'block';
            currentSuggestionIndex = -1;
            
            // Add click handlers to suggestions
            suggestionsContainer.querySelectorAll('.search-suggestion-item').forEach((item, index) => {
                item.addEventListener('click', () => {
                    selectSuggestion(index);
                });
                
                item.addEventListener('mouseenter', () => {
                    highlightSuggestion(index);
                });
            });
        }
        
        // Hide suggestions
        function hideSuggestions() {
            suggestionsContainer.style.display = 'none';
            currentSuggestionIndex = -1;
        }
        
        // Highlight suggestion
        function highlightSuggestion(index) {
            const items = suggestionsContainer.querySelectorAll('.search-suggestion-item');
            items.forEach((item, i) => {
                if (i === index) {
                    item.classList.add('bg-light');
                    item.setAttribute('aria-selected', 'true');
                } else {
                    item.classList.remove('bg-light');
                    item.setAttribute('aria-selected', 'false');
                }
            });
            currentSuggestionIndex = index;
        }
        
        // Select suggestion
        function selectSuggestion(index) {
            if (suggestions[index]) {
                window.location.href = suggestions[index].url;
            }
        }
        
        // Get icon class for content type
        function getIconClass(type) {
            const icons = {
                'post': 'fas fa-comment',
                'thread': 'fas fa-comments',
                'user': 'fas fa-user',
                'category': 'fas fa-folder',
                'subcategory': 'fas fa-folder-open'
            };
            return icons[type] || 'fas fa-search';
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Event listeners
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            const query = e.target.value.trim();
            
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300); // 300ms debounce
        });
        
        // Keyboard navigation
        searchInput.addEventListener('keydown', function(e) {
            const suggestionItems = suggestionsContainer.querySelectorAll('.search-suggestion-item');
            
            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    if (currentSuggestionIndex < suggestions.length - 1) {
                        highlightSuggestion(currentSuggestionIndex + 1);
                    }
                    break;
                    
                case 'ArrowUp':
                    e.preventDefault();
                    if (currentSuggestionIndex > 0) {
                        highlightSuggestion(currentSuggestionIndex - 1);
                    }
                    break;
                    
                case 'Enter':
                    if (currentSuggestionIndex >= 0) {
                        e.preventDefault();
                        selectSuggestion(currentSuggestionIndex);
                    }
                    // If no suggestion selected, allow form submission
                    break;
                    
                case 'Escape':
                    hideSuggestions();
                    searchInput.blur();
                    break;
            }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !suggestionsContainer.contains(e.target)) {
                hideSuggestions();
            }
        });
        
        // Show suggestions when focusing if there's a query
        searchInput.addEventListener('focus', function() {
            if (searchInput.value.length >= 2) {
                performSearch(searchInput.value);
            }
        });
    });
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>